name: Secret Scanning - Gitleaks

# Automated secret scanning using Gitleaks (MIT License, Free)
# Scans repository for exposed secrets and credentials
# Reports findings to GitHub Security tab via SARIF

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC to catch any missed secrets
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for comprehensive scanning
      
      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional: for Gitleaks Enterprise features
        with:
          # Scan full repository history
          args: --verbose --redact
      
      - name: Generate SARIF Report
        if: always()
        run: |
          echo "Generating SARIF report for GitHub Security tab..."
          # Gitleaks action already generates results, this ensures it's in the right format
      
      - name: Upload SARIF report to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
          category: gitleaks
        continue-on-error: true
      
      - name: Comment on PR with results
        if: failure() && github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ðŸ”’ Secret Scanning Alert
            
            Gitleaks has detected potential secrets in this pull request.
            
            **Action Required:**
            1. Review the detected secrets in the workflow logs
            2. Remove any exposed credentials from the code
            3. Rotate any compromised credentials immediately
            4. Update your code to use environment variables or secret management
            
            **Security Resources:**
            - [Secret Management Best Practices](../blob/main/SECURITY.md)
            - [How to Remove Secrets from Git History](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/removing-sensitive-data-from-a-repository)
            
            View full report: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      
      - name: Fail on secrets detected
        if: steps.gitleaks.outcome == 'failure'
        run: |
          echo "âŒ Secrets detected in repository!"
          echo "Please review and remove all exposed credentials before merging."
          exit 1

  report-summary:
    name: Secret Scan Summary
    runs-on: ubuntu-latest
    needs: gitleaks
    if: always()
    
    steps:
      - name: Generate scan summary
        run: |
          echo "# ðŸ”’ Secret Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Scanner:** Gitleaks v8 (MIT License)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.gitleaks.result }}" == "success" ]; then
            echo "âœ… **Status:** No secrets detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The repository scan completed successfully with no exposed credentials found." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Status:** Secrets detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review detected secrets in the workflow logs" >> $GITHUB_STEP_SUMMARY
            echo "2. Remove all exposed credentials" >> $GITHUB_STEP_SUMMARY
            echo "3. Rotate compromised credentials immediately" >> $GITHUB_STEP_SUMMARY
            echo "4. Use environment variables or secret management" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resources:**" >> $GITHUB_STEP_SUMMARY
          echo "- [Security Policy](../blob/main/SECURITY.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Secret Scanning Guide](../blob/main/SECRET_SCANNING.md)" >> $GITHUB_STEP_SUMMARY
